@page "/dashboard"
@using System.Globalization
@using Platform.Data.DTOs
@using Platform.Blazor.Services.Employees
@using Platform.Blazor.Services.Leaves
@using Platform.Blazor.Services.Polls
@using Platform.Blazor.Services.Events
@using Platform.Blazor.Services.Hierarchies
@using Microsoft.Extensions.Localization
@using Platform.Blazor.Resources
@inject IEmployeesService EmployeesService
@inject LeaveService LeavesService
@inject IPollsService PollsService
@inject IEventsService EventsService
@inject IHierarchiesService HierarchiesService
@inject IStringLocalizer<AppStrings> Loc
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">@Loc["Dashboard"]</MudText>
    <MudText Class="mb-8">@Loc["DashboardWelcome"]</MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
    }
    else
    {
        <!-- Top Row: Summary Cards -->
        <MudGrid Class="mb-8">
            <MudItem xs="12" sm="6" md="4" lg="2">
                <MudPaper Class="d-flex flex-column align-center justify-center py-8 mud-elevation-4">
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Color="Color.Primary" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_totalEmployees</MudText>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@Loc["Employees"]</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" lg="2">
                <MudPaper Class="d-flex flex-column align-center justify-center py-8 mud-elevation-4">
                    <MudIcon Icon="@Icons.Material.Filled.TimeToLeave" Size="Size.Large" Color="Color.Warning" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_pendingLeavesCount</MudText>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@Loc["PendingLeaves"]</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" lg="2">
                <MudPaper Class="d-flex flex-column align-center justify-center py-8 mud-elevation-4">
                    <MudIcon Icon="@Icons.Material.Filled.Poll" Size="Size.Large" Color="Color.Success" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_activePollsCount</MudText>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@Loc["ActivePolls"]</MudText>
                </MudPaper>
            </MudItem>
             <MudItem xs="12" sm="6" md="4" lg="2">
                <MudPaper Class="d-flex flex-column align-center justify-center py-8 mud-elevation-4">
                    <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Large" Color="Color.Info" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_upcomingEventsCount</MudText>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@Loc["UpcomingEvents"]</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" lg="2">
                <MudPaper Class="d-flex flex-column align-center justify-center py-8 mud-elevation-4">
                    <MudIcon Icon="@Icons.Material.Filled.AccountTree" Size="Size.Large" Color="Color.Tertiary" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_totalHierarchies</MudText>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@Loc["Hierarchies"]</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudGrid>
            <!-- Middle Row: Left Column (Quick Actions & Pending Leaves) -->
            <MudItem xs="12">
                <MudGrid>
                    <!-- Quick Actions -->
                    <AuthorizeView Roles="HR" Context="authContext">
                        <MudItem xs="12">
                            <MudCard Elevation="4">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@Loc["QuickActions"]</MudText>
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent>
                                    <div class="d-flex gap-4 flex-wrap">
                                        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PersonAdd" Color="Color.Primary" OnClick="@(() => Nav.NavigateTo("/hr/employees/add"))">
                                            @Loc["AddEmployee"]
                                        </MudButton>
                                        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Announcement" Color="Color.Secondary" OnClick="@(() => Nav.NavigateTo("/announcements/create"))">
                                            @Loc["NewAnnouncement"]
                                        </MudButton>
                                         <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Event" Color="Color.Info" OnClick="@(() => Nav.NavigateTo("/events/create"))">
                                            @Loc["NewEvent"]
                                        </MudButton>
                                        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Poll" Color="Color.Success" OnClick="@(() => Nav.NavigateTo("/polls/create"))">
                                            @Loc["CreatePoll"]
                                        </MudButton>
                                    </div>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </AuthorizeView>

                    <!-- Pending Leave Requests Preview -->
                    <AuthorizeView Roles="HR" Context="authContext">
                        <MudItem xs="12">
                            <MudCard Elevation="4">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@Loc["PendingLeaveRequests"]</MudText>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => Nav.NavigateTo("/leaves/requests"))">@Loc["ViewAll"]</MudButton>
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent>
                                    @if (_pendingLeaves == null || !_pendingLeaves.Any())
                                    {
                                        <MudText>@Loc["NoPendingLeaves"]</MudText>
                                    }
                                    else
                                    {
                                        <MudList T="Leave" Dense="true">
                                            @foreach (var leave in _pendingLeaves.Take(5))
                                            {
                                                <MudListItem Icon="@Icons.Material.Filled.DateRange">
                                                    <div class="d-flex justify-space-between align-center width-100">
                                                        <div>
                                                            <MudText Typo="Typo.subtitle2">@($"{leave.EmployeeId} - {leave.LeaveTypeId}")</MudText>
                                                            <MudText Typo="Typo.caption">@($"{leave.StartDate:d} - {leave.EndDate:d}")</MudText>
                                                        </div>
                                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small">@Loc["Pending"]</MudChip>
                                                    </div>
                                                </MudListItem>
                                                <MudDivider />
                                            }
                                        </MudList>
                                    }
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </AuthorizeView>
                </MudGrid>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private bool _isLoading = true;
    private int _totalEmployees;
    private int _pendingLeavesCount;
    private int _activePollsCount;
    private int _upcomingEventsCount;
    private int _totalHierarchies;
    private List<Leave> _pendingLeaves = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        _isLoading = true;
        try
        {
            var tEmployees = EmployeesService.GetAllEmployeesAsync();
            var tLeaves = LeavesService.GetPendingLeaves();
            var tPolls = PollsService.GetActivePollsAsync();
            var tEvents = EventsService.GetEventsAsync();
            var tHierarchies = HierarchiesService.GetHierarchiesAsync();

            await Task.WhenAll(tEmployees, tLeaves, tPolls, tEvents, tHierarchies);

            _totalEmployees = (await tEmployees)?.Count ?? 0;
            
            var leaves = await tLeaves ?? new List<Leave>();
            _pendingLeaves = leaves.Take(5).ToList();
            _pendingLeavesCount = leaves.Count;

            _activePollsCount = (await tPolls)?.Count ?? 0;
            _upcomingEventsCount = (await tEvents)?.Count(e => e.StartDate >= DateTime.Now) ?? 0;
            _totalHierarchies = (await tHierarchies)?.Count ?? 0;
            
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading dashboard: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
