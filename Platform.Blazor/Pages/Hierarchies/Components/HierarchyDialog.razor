@using Platform.Data.DTOs
@using Platform.Blazor.Services.Hierarchies
@using MudBlazor
@using Microsoft.Extensions.Localization
@using Platform.Blazor.Resources
@inject IHierarchiesService HierarchiesService
@inject ISnackbar Snackbar
@inject IStringLocalizer<AppStrings> Loc

@code {
    private bool IsRtl => System.Globalization.CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
    private bool IsArabic => System.Globalization.CultureInfo.CurrentUICulture.Name.StartsWith("ar");
}

<MudOverlay @bind-Visible="Visible" DarkBackground="true" AutoClose="false" ZIndex="1200">
    <MudPaper Class="pa-4" Style="width: 450px; max-width: 95vw;" dir="@(IsRtl ? "rtl" : "ltr")">
        <MudText Typo="Typo.h6" Class="mb-4">@(_isEdit ? Loc["EditHierarchy"] : Loc["AddHierarchy"])</MudText>
        <MudForm @ref="_form" @bind-IsValid="_success">
            <MudStack Spacing="2">
                <MudTextField Label="@Loc["Name"]" @bind-Value="_hierarchy.Name" Required="true" For="@(() => _hierarchy.Name)" />
                <MudTextField Label="@Loc["NameAr"]" @bind-Value="_hierarchy.NameAr" For="@(() => _hierarchy.NameAr)" />
                
                <MudSelect T="int" Label="@Loc["HierarchyLevel"]" @bind-Value="_hierarchy.HierarchyLevelId" 
                           AnchorOrigin="Origin.BottomCenter" PopOverInheritStyle="true" Required="true">
                    @foreach (var level in _levels)
                    {
                        <MudSelectItem Value="@level.Id">
                            @(IsArabic && !string.IsNullOrEmpty(level.NameAr) ? level.NameAr : level.Name)
                        </MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="int" Label="@Loc["Parent"]" @bind-Value="_hierarchy.ParentId" 
                           AnchorOrigin="Origin.BottomCenter" PopOverInheritStyle="true">
                    <MudSelectItem Value="0">@Loc["Root"]</MudSelectItem>
                    @foreach (var h in _potentialParents) 
                    {
                        <MudSelectItem Value="@h.Id">
                            @(IsArabic && !string.IsNullOrEmpty(h.NameAr) ? h.NameAr : h.Name)
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudStack>
        </MudForm>
        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-6">
            <MudButton OnClick="Cancel" Class="px-6">@Loc["Cancel"]</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Class="px-8">@Loc["Save"]</MudButton>
        </MudStack>
    </MudPaper>
</MudOverlay>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    [Parameter] public int? HierarchyId { get; set; }
    [Parameter] public int? DefaultParentId { get; set; }

    private Hierarchy _hierarchy = new();
    private List<HierarchyLevel> _levels = new();
    private List<Hierarchy> _allHierarchies = new();
    private List<Hierarchy> _potentialParents => _allHierarchies.Where(x => x.Id != _hierarchy.Id).ToList();

    private MudForm _form;
    private bool _success;
    private bool _isEdit => HierarchyId.HasValue && HierarchyId.Value > 0;

    protected override async Task OnParametersSetAsync()
    {
        if (Visible)
        {
             await LoadLookups();

            if (_isEdit)
            {
                 var existing = _allHierarchies.FirstOrDefault(x => x.Id == HierarchyId.Value);
                 if (existing != null) 
                 {
                     _hierarchy = new Hierarchy {
                         Id = existing.Id,
                         Name = existing.Name,
                         NameAr = existing.NameAr,
                         HierarchyLevelId = existing.HierarchyLevelId,
                         ParentId = existing.ParentId
                     };
                 }
            }
            else
            {
                _hierarchy = new Hierarchy { ParentId = DefaultParentId ?? 0 };
            }
        }
    }

    private async Task LoadLookups()
    {
         var levelsTask = HierarchiesService.GetLevelsAsync();
         var hierarchiesTask = HierarchiesService.GetHierarchiesAsync();
         await Task.WhenAll(levelsTask, hierarchiesTask);
         _levels = await levelsTask;
         _allHierarchies = await hierarchiesTask;
    }

    private async Task Submit()
    {
        await _form.Validate();
        if (_success)
        {
            try 
            {
                if (_isEdit)
                {
                    await HierarchiesService.UpdateHierarchyAsync(_hierarchy.Id, _hierarchy);
                    Snackbar.Add(Loc["HierarchyUpdated"], Severity.Success);
                }
                else
                {
                    await HierarchiesService.CreateHierarchyAsync(_hierarchy);
                    Snackbar.Add(Loc["HierarchyCreated"], Severity.Success);
                }
                await Close(true);
            }
            catch(Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task Close(bool result)
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        await OnClose.InvokeAsync(result);
    }
    
    private async Task Cancel() => await Close(false);
}
