@page "/my-leaves"
@layout MainLayout
@using Platform.Data.DTOs
@using Platform.Blazor.Services.Leaves
@using System.Security.Claims
@using MudBlazor
@inject LeaveService LeaveService
@inject AuthenticationStateProvider AuthStateProvider
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h5" GutterBottom="true">@Loc["MyLeaves"]</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenRequestDialog" Class="mb-4">
    @Loc["NewLeaveRequest"]
</MudButton>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Loc["MyBalances"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (Balances == null)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else
                {
                    <MudTable Items="Balances" Dense="true" Hover="true" Striped="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>@Loc["Type"]</MudTh>
                            <MudTh>@Loc["Balance"]</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Type">@context.LeaveType?.NameAr</MudTd>
                            <MudTd DataLabel="Balance">@context.Balance</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="8">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Loc["LeaveHistory"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (MyLeavesList == null)
                {
                     <MudProgressCircular Indeterminate="true" />
                }
                else
                {
                     <MudTable Items="MyLeavesList" Dense="true" Hover="true" Striped="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>@Loc["Type"]</MudTh>
                            <MudTh>@Loc["StartDate"]</MudTh>
                            <MudTh>@Loc["EndDate"]</MudTh>
                            <MudTh>@Loc["Status"]</MudTh>
                            <MudTh>@Loc["Details"]</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Type">@context.LeaveType?.NameAr</MudTd>
                            <MudTd DataLabel="Start">@context.StartDate.ToShortDateString()</MudTd>
                            <MudTd DataLabel="End">@context.EndDate.ToShortDateString()</MudTd>
                            <MudTd DataLabel="Status">@context.LeaveStatus?.NameAr</MudTd>
                            <MudTd DataLabel="Details">@context.Details</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private List<LeaveBalance> Balances;
    private List<Leave> MyLeavesList;
    private List<LeaveType> LeaveTypes = new();
    
    private int CurrentEmployeeId; 
    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState;
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var employeeIdClaim = user.FindFirst("EmployeeId");
            if (employeeIdClaim != null && int.TryParse(employeeIdClaim.Value, out int empId))
            {
                CurrentEmployeeId = empId;
                await LoadData();
                LeaveTypes = await LeaveService.GetLeaveTypes();
            }
            else
            {
                // Handle case where user is logged in but has no linked employee
                // Handle case where user is logged in but has no linked employee
                // It is possible the token is stale (from before the fix), so suggest relogin.
                Snackbar.Add("Account not linked to employee record. Please Log Out and Log In again.", Severity.Warning);
            }
        }
    }

    private async Task LoadData()
    {
        if(CurrentEmployeeId > 0)
        {
             Balances = await LeaveService.GetMyBalances(CurrentEmployeeId);
             MyLeavesList = await LeaveService.GetMyLeavesAndRequests(CurrentEmployeeId);
        }
    }

    private async Task OpenRequestDialog()
    {
        var parameters = new DialogParameters
        {
            { nameof(LeaveRequestDialog.LeaveTypes), LeaveTypes },
            { nameof(LeaveRequestDialog.EmployeeId), CurrentEmployeeId }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<LeaveRequestDialog>(Loc["NewLeaveRequest"], parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is bool success && success)
        {
            await LoadData();
        }
    }
}
