@page "/leave-configuration"
@using Platform.Data.DTOs
@using Platform.Blazor.Services.Leaves
@inject LeaveService LeaveService
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudText Typo="Typo.h5" GutterBottom="true">Leave Configuration</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Loc["LeaveTypes"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudTable Items="@LeaveTypes" Dense="true" Hover="true" CanCancelEdit="true" 
                          CommitEditTooltip="Commit Edit" CancelEditTooltip="Discard Changes" 
                          RowEditPreview="BackupTypeItem" RowEditCancel="ResetTypeItem" RowEditCommit="TypeItemHasBeenCommitted"
                          IsEditRowSwitchingBlocked="true" ApplyButtonPosition="TableApplyButtonPosition.End" EditButtonPosition="TableEditButtonPosition.End" EditTrigger="TableEditTrigger.EditButton">
                    <HeaderContent>
                        <MudTh>@Loc["NameAr"]</MudTh>
                        <MudTh>@Loc["NameEn"]</MudTh>
                        <MudTh>@Loc["Balance"]</MudTh>
                        <MudTh>@Loc["Actions"]</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name (AR)">@context.NameAr</MudTd>
                        <MudTd DataLabel="Name (EN)">@context.Name</MudTd>
                        <MudTd DataLabel="Balance">@context.TypeBalance</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteType(context.Id))" />
                        </MudTd>
                    </RowTemplate>
                    <RowEditingTemplate>
                        <MudTd DataLabel="Name (AR)">
                            <MudTextField @bind-Value="@context.NameAr" Required />
                        </MudTd>
                        <MudTd DataLabel="Name (EN)">
                            <MudTextField @bind-Value="@context.Name" />
                        </MudTd>
                        <MudTd DataLabel="Balance">
                            <MudNumericField @bind-Value="@context.TypeBalance" />
                        </MudTd>
                    </RowEditingTemplate>
                </MudTable>

                <div class="d-flex gap-2 mt-4">
                     <MudTextField @bind-Value="NewTypeName" Label="@Loc["NameAr"]" Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" />
                     <MudTextField @bind-Value="NewTypeNameEn" Label="@Loc["NameEn"]" Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" />
                     <MudNumericField @bind-Value="NewTypeBalance" Label="@Loc["Balance"]" Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" />
                     <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddType">@Loc["Add"]</MudButton>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

     <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                 <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Loc["LeaveStatuses"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                 <MudTable Items="@LeaveStatuses" Dense="true" Hover="true" CanCancelEdit="true"
                          CommitEditTooltip="Commit Edit" CancelEditTooltip="Discard Changes"
                          RowEditPreview="BackupStatusItem" RowEditCancel="ResetStatusItem" RowEditCommit="StatusItemHasBeenCommitted"
                          IsEditRowSwitchingBlocked="true" ApplyButtonPosition="TableApplyButtonPosition.End" EditButtonPosition="TableEditButtonPosition.End" EditTrigger="TableEditTrigger.EditButton">
                    <HeaderContent>
                        <MudTh>@Loc["NameAr"]</MudTh>
                        <MudTh>@Loc["NameEn"]</MudTh>
                        <MudTh>@Loc["Actions"]</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name (AR)">@context.NameAr</MudTd>
                        <MudTd DataLabel="Name (EN)">@context.Name</MudTd>
                         <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteStatus(context.Id))" />
                        </MudTd>
                    </RowTemplate>
                    <RowEditingTemplate>
                        <MudTd DataLabel="Name (AR)">
                            <MudTextField @bind-Value="@context.NameAr" Required />
                        </MudTd>
                         <MudTd DataLabel="Name (EN)">
                            <MudTextField @bind-Value="@context.Name" />
                        </MudTd>
                    </RowEditingTemplate>
                </MudTable>

                 <div class="d-flex gap-2 mt-4">
                     <MudTextField @bind-Value="NewStatusName" Label="@Loc["NameAr"]" Variant="Variant.Outlined" Margin="Margin.Dense" />
                     <MudTextField @bind-Value="NewStatusNameEn" Label="@Loc["NameEn"]" Variant="Variant.Outlined" Margin="Margin.Dense" />
                     <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddStatus">@Loc["Add"]</MudButton>
                 </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private List<LeaveType> LeaveTypes = new();
    private List<LeaveStatus> LeaveStatuses = new();

    private string NewTypeName;
    private string NewTypeNameEn;
    private int? NewTypeBalance;
    private string NewStatusName;
    private string NewStatusNameEn;

    // Backup for edit revert
    private LeaveType _typeBeforeEdit;
    private LeaveStatus _statusBeforeEdit;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try {
            LeaveTypes = await LeaveService.GetLeaveTypes();
            LeaveStatuses = await LeaveService.GetLeaveStatuses();
        } catch (Exception ex) {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    // --- Types CRUD ---

    private async Task AddType()
    {
        if (string.IsNullOrWhiteSpace(NewTypeName)) return;
        var type = new LeaveType { NameAr = NewTypeName, Name = NewTypeNameEn, TypeBalance = NewTypeBalance };
        var response = await Http.PostAsJsonAsync("api/LeaveTypes", type);
        if (response.IsSuccessStatusCode)
        {
            NewTypeName = ""; NewTypeNameEn = ""; NewTypeBalance = null;
            Snackbar.Add("Type added", Severity.Success);
            await LoadData();
        }
        else
        {
             var error = await response.Content.ReadAsStringAsync();
             Snackbar.Add($"Error adding type: {error}", Severity.Error);
        }
    }

    private void BackupTypeItem(object element)
    {
        var item = (LeaveType)element;
        _typeBeforeEdit = new LeaveType { Id = item.Id, NameAr = item.NameAr, Name = item.Name, TypeBalance = item.TypeBalance };
    }

    private void ResetTypeItem(object element)
    {
        var item = (LeaveType)element;
        if (_typeBeforeEdit != null)
        {
            item.NameAr = _typeBeforeEdit.NameAr;
            item.Name = _typeBeforeEdit.Name;
            item.TypeBalance = _typeBeforeEdit.TypeBalance;
        }
    }

    private async void TypeItemHasBeenCommitted(object element)
    {
        var item = (LeaveType)element;
        var response = await Http.PutAsJsonAsync($"api/LeaveTypes/{item.Id}", item);
        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("Type updated", Severity.Success);
        }
        else
        {
             var error = await response.Content.ReadAsStringAsync();
             Snackbar.Add($"Error updating type: {error}", Severity.Error);
             // Ideally revert change here, but MudTable API makes it tricky from outside.
             // Reloading data might restore state.
             await LoadData();
        }
    }

    private async Task DeleteType(int id)
    {
        var type = LeaveTypes.FirstOrDefault(x => x.Id == id);
        if (type == null) return;

        bool? result = await DialogService.ShowMessageBox(
            Loc["Warning"], 
            string.Format(Loc["ConfirmDelete"], $"({(System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar") ? type.NameAr : type.Name)})"),
            yesText: Loc["Delete"], cancelText: Loc["Cancel"]);

        if (result == true)
        {
            var response = await Http.DeleteAsync($"api/LeaveTypes/{id}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add(Loc["TypeDeleted"], Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add($"Error deleting type: {response.ReasonPhrase}", Severity.Error);
            }
        }
    }

    // --- Statuses CRUD ---

    private async Task AddStatus()
    {
        if (string.IsNullOrWhiteSpace(NewStatusName)) return;
        var status = new LeaveStatus { NameAr = NewStatusName, Name = NewStatusNameEn };
        var response = await Http.PostAsJsonAsync("api/LeaveStatuses", status);
        if (response.IsSuccessStatusCode)
        {
            NewStatusName = "";
            NewStatusNameEn = "";
            Snackbar.Add("Status added", Severity.Success);
            await LoadData();
        }
        else
        {
             var error = await response.Content.ReadAsStringAsync();
             Snackbar.Add($"Error adding status: {error}", Severity.Error);
        }
    }

    private void BackupStatusItem(object element)
    {
        var item = (LeaveStatus)element;
        _statusBeforeEdit = new LeaveStatus { Id = item.Id, NameAr = item.NameAr, Name = item.Name };
    }

    private void ResetStatusItem(object element)
    {
        var item = (LeaveStatus)element;
        if (_statusBeforeEdit != null)
        {
            item.NameAr = _statusBeforeEdit.NameAr;
            item.Name = _statusBeforeEdit.Name;
        }
    }

    private async void StatusItemHasBeenCommitted(object element)
    {
        var item = (LeaveStatus)element;
        var response = await Http.PutAsJsonAsync($"api/LeaveStatuses/{item.Id}", item);
        if (response.IsSuccessStatusCode)
        {
            Snackbar.Add("Status updated", Severity.Success);
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            Snackbar.Add($"Error updating status: {error}", Severity.Error);
            await LoadData();
        }
    }

    private async Task DeleteStatus(int id)
    {
        var status = LeaveStatuses.FirstOrDefault(x => x.Id == id);
        if (status == null) return;

        bool? result = await DialogService.ShowMessageBox(
            Loc["Warning"], 
            string.Format(Loc["ConfirmDelete"], $"({(System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar") ? status.NameAr : status.Name)})"), 
            yesText: Loc["Delete"], cancelText: Loc["Cancel"]);

        if (result == true)
        {
            var response = await Http.DeleteAsync($"api/LeaveStatuses/{id}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add(Loc["StatusDeleted"], Severity.Success);
                await LoadData();
            }
            else
            {
                 Snackbar.Add($"Error deleting status: {response.ReasonPhrase}", Severity.Error);
            }
        }
    }
}
