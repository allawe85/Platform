@page "/leave-approvals"
@using Platform.Data.DTOs
@using Platform.Blazor.Services.Leaves
@inject LeaveService LeaveService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h5" GutterBottom="true">@Loc["LeaveApprovals"]</MudText>

<MudTable Items="PendingLeaves" Hover="true" Loading="@(PendingLeaves == null)">
    <HeaderContent>
        <MudTh>@Loc["Employee"]</MudTh>
        <MudTh>@Loc["LeaveType"]</MudTh>
        <MudTh>@Loc["StartDate"]</MudTh>
        <MudTh>@Loc["EndDate"]</MudTh>
        <MudTh>@Loc["Days"]</MudTh>
        <MudTh>@Loc["Details"]</MudTh>
        <MudTh>@Loc["Actions"]</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Employee">@context.Employee?.FullName</MudTd>
        <MudTd DataLabel="Type">@context.LeaveType?.NameAr</MudTd>
        <MudTd DataLabel="Start">@context.StartDate.ToShortDateString()</MudTd>
        <MudTd DataLabel="End">@context.EndDate.ToShortDateString()</MudTd>
        <MudTd DataLabel="Days">@((context.EndDate - context.StartDate).Days + 1)</MudTd>
        <MudTd DataLabel="Details">@context.Details</MudTd>
        <MudTd>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" OnClick="@(() => Approve(context))">@Loc["Approve"]</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small" OnClick="@(() => Reject(context))">@Loc["Reject"]</MudButton>
            </MudStack>
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText>@Loc["NoRecordsFound"]</MudText>
    </NoRecordsContent>
</MudTable>

@code {
    private List<Leave> PendingLeaves;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        PendingLeaves = await LeaveService.GetPendingLeaves();
    }

    private async Task Approve(Leave leave)
    {
        var result = await LeaveService.ApproveLeave(leave.Id);
        if (result.IsSuccessStatusCode)
        {
            Snackbar.Add(Loc["RequestApproved"], Severity.Success);
            await LoadData();
        }
    }

    private async Task Reject(Leave leave)
    {
        var result = await LeaveService.RejectLeave(leave.Id);
        if (result.IsSuccessStatusCode)
        {
            Snackbar.Add(Loc["RequestRejected"], Severity.Info);
            await LoadData();
        }
    }
}
