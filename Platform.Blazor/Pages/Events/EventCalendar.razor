@page "/events"
@using Platform.Blazor.Services.Events
@using Platform.Data.DTOs
@inject IEventsService EventsService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h5" Class="mb-4">@Loc["EventCalendarTitle"]</MudText>

<MudPaper Class="pa-4 mb-4">
    <MudGrid>
        <MudItem xs="12" md="4">
            <MudDateRangePicker Label="@Loc["DateRange"]" @bind-DateRange="_dateRange" PlaceholderStart="@Loc["StartDate"]" PlaceholderEnd="@Loc["EndDate"]" />
        </MudItem>
        <MudItem xs="12" md="4">
             <MudSelect T="int?" Label="@Loc["EventType"]" @bind-Value="_selectedEventTypeId" Clearable="true">
                @foreach (var type in _eventTypes)
                {
                    <MudSelectItem Value="@((int?)type.Id)">@type.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4" Class="d-flex align-center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadEvents" Class="mr-2">@Loc["Filter"]</MudButton>
             <MudSpacer />
            <AuthorizeView Roles="Admin,HR">
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="AddEvent">@Loc["Add"]</MudButton>
            </AuthorizeView>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" Class="ma-4" />
}
else
{
    <MudPaper Class="pa-4">
        @if (_events.Any())
        {
            <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                @foreach (var evt in _events)
                {
                    var name = GetLocalizedValue(evt.Name, evt.NameAr);
                    var location = GetLocalizedValue(evt.Location, evt.LocationAr);
                    var description = GetLocalizedValue(evt.Description, evt.DescriptionAr);
                    var eventType = evt.EventType != null ? GetLocalizedValue(evt.EventType.Name, evt.EventType.NameAr) : Loc["Unknown"];

                    <MudTimelineItem Color="@GetColorForType(evt.EventTypeId)" Size="Size.Small">
                        <ItemOpposite>
                            <MudText Color="Color.Default" Typo="Typo.caption">@evt.StartDate.ToShortDateString()</MudText>
                            <MudText Color="Color.Default" Typo="Typo.caption">@evt.StartDate.ToShortTimeString()</MudText>
                        </ItemOpposite>
                        <ItemContent>
                            <MudCard Elevation="2" Class="mb-3">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.body1"><b>@name</b></MudText>
                                        <MudText Typo="Typo.caption">@location</MudText>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                          <AuthorizeView Roles="Admin,HR">
                                              <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => EditEvent(evt))" />
                                              <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteEvent(evt))" />
                                          </AuthorizeView>
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudText Typo="Typo.body2">@description</MudText>
                                     <MudChip T="string" Size="Size.Small" Color="@GetColorForType(evt.EventTypeId)" Class="mt-2">
                                        @eventType
                                    </MudChip>
                                </MudCardContent>
                            </MudCard>
                        </ItemContent>
                    </MudTimelineItem>
                }
            </MudTimeline>
        }
        else
        {
             <MudText Class="ma-4">@Loc["NoEventsFound"]</MudText>
        }
    </MudPaper>
}



@code {
    private List<Event> _events = new();
    private List<EventType> _eventTypes = new();
    private bool _loading = true;
    private DateRange _dateRange = new DateRange(null, null);
    private int? _selectedEventTypeId;
    
    // Localization Helper
    private bool IsArabic => System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar", StringComparison.OrdinalIgnoreCase);

    private string GetLocalizedValue(string en, string ar)
    {
        if (IsArabic && !string.IsNullOrEmpty(ar))
        {
            return ar;
        }
        return en;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadEventTypes();
        await LoadEvents();
    }

    private async Task LoadEventTypes()
    {
        try
        {
            _eventTypes = await EventsService.GetEventTypesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading types: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadEvents()
    {
        _loading = true;
        try
        {
            List<Event> events;

            if (_dateRange.Start.HasValue && _dateRange.End.HasValue)
            {
                events = await EventsService.GetEventsByRangeAsync(_dateRange.Start.Value, _dateRange.End.Value);
            }
            else
            {
                events = await EventsService.GetEventsAsync();
            }
                
            if (_selectedEventTypeId.HasValue)
            {
                events = events.Where(e => e.EventTypeId == _selectedEventTypeId.Value).ToList();
            }

            _events = events.OrderBy(e => e.StartDate).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading events: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private Color GetColorForType(int typeId)
    {
        var colors = new[] { Color.Primary, Color.Secondary, Color.Tertiary, Color.Info, Color.Success, Color.Warning, Color.Error };
        return colors[typeId % colors.Length];
    }

    // --- Actions ---

    private async Task AddEvent()
    {
        var newEvent = new Event { StartDate = DateTime.Now, EndDate = DateTime.Now.AddHours(1) };
        await OpenDialog(newEvent, Loc["Add"]);
    }

    private async Task EditEvent(Event e)
    {
        // Clone the object to avoid modifying the list directly before saving
        var eventToEdit = new Event
        {
            Id = e.Id,
            Name = e.Name,
            NameAr = e.NameAr,
            Location = e.Location,
            LocationAr = e.LocationAr,
            Description = e.Description,
            DescriptionAr = e.DescriptionAr,
            EventTypeId = e.EventTypeId,
            StartDate = e.StartDate,
            EndDate = e.EndDate
        };
        await OpenDialog(eventToEdit, Loc["Edit"]);
    }

    private async Task OpenDialog(Event eventModel, string title)
    {
         var parameters = new DialogParameters
         {
             { nameof(EventDialog.EventModel), eventModel },
             { nameof(EventDialog.EventTypes), _eventTypes },
             { nameof(EventDialog.Title), title }
         };

         var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
         var dialog = DialogService.Show<EventDialog>(title, parameters, options);
         var result = await dialog.Result;

         if (!result.Canceled && result.Data is Event savedEvent)
         {
             try
             {
                 if (savedEvent.Id == 0)
                 {
                     await EventsService.CreateEventAsync(savedEvent);
                 }
                 else
                 {
                     await EventsService.UpdateEventAsync(savedEvent.Id, savedEvent);
                 }
                 Snackbar.Add(Loc["Success"], Severity.Success);
                 await LoadEvents();
             }
             catch (Exception ex)
             {
                 Snackbar.Add($"Error saving event: {ex.Message}", Severity.Error);
             }
         }
    }

    private void DeleteEvent(Event e)
    {
         Task.Run(async () => {
             try {
                bool? result = await DialogService.ShowMessageBox(
                    Loc["Warning"], 
                    string.Format(Loc["ConfirmDelete"], $"({(System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar") ? e.NameAr : e.Name)})"), 
                    yesText: Loc["Delete"], cancelText: Loc["Cancel"]);

                if (result == true)
                {
                    await EventsService.DeleteEventAsync(e.Id);
                    Snackbar.Add(Loc["Success"], Severity.Success);
                    await LoadEvents();
                }
             } catch (Exception ex) {
                 Snackbar.Add(ex.Message, Severity.Error);
             }
         });
    }
}
