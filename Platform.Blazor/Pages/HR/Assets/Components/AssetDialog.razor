@using Platform.Data.DTOs
@using Platform.Blazor.Services.Assets
@using Platform.Blazor.Services.Lookups
@using Platform.Blazor.Services.Employees
@using MudBlazor
@inject IAssetsService AssetsService
@inject ILookupsService LookupsService
@inject IEmployeesService EmployeesService
@inject ISnackbar Snackbar

<MudOverlay @bind-Visible="Visible" DarkBackground="true" AutoClose="false" ZIndex="9999">
    <MudPaper Class="pa-4" Style="width: 400px; max-width: 90vw;">
        <MudText Typo="Typo.h6" Class="mb-4">@(_isEdit ? Loc["EditAsset"] : Loc["AddAsset"])</MudText>
        <MudForm @ref="_form" @bind-IsValid="_success">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_asset.Details" Label="@Loc["Details"]" Required="true" Lines="3" />
                
                <MudSelect T="int?" Value="@(_asset.AssetTypeId == 0 ? (int?)null : _asset.AssetTypeId)" ValueChanged="@(val => _asset.AssetTypeId = val ?? 0)" Label="@Loc["AssetType"]" Required="true" AnchorOrigin="Origin.BottomCenter" Placeholder="@Loc["PleaseSelect"]">
                    @foreach (var type in _assetTypes)
                    {
                        <MudSelectItem T="int?" Value="@((int?)type.Id)">@type.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="int?" Value="@(_asset.StatusId == 0 ? (int?)null : _asset.StatusId)" ValueChanged="@(val => _asset.StatusId = val ?? 0)" Label="@Loc["Status"]" Required="true" AnchorOrigin="Origin.BottomCenter" Placeholder="@Loc["PleaseSelect"]">
                    @foreach (var status in _assetStatuses)
                    {
                        <MudSelectItem T="int?" Value="@((int?)status.Id)">@status.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="int?" @bind-Value="_asset.EmployeeId" Label="@Loc["AssignedEmployee"]" Clearable="true" AnchorOrigin="Origin.BottomCenter" Placeholder="@Loc["PleaseSelect"]">
                    @foreach (var emp in _employees)
                    {
                        <MudSelectItem T="int?" Value="@((int?)emp.Id)">@emp.FullName</MudSelectItem>
                    }
                </MudSelect>

                <MudDatePicker Label="@Loc["ReceiveDate"]" @bind-Date="_receiveDate" />
                <MudDatePicker Label="@Loc["ReturnDate"]" @bind-Date="_returnDate" Clearable="true" />
            </MudStack>
        </MudForm>
        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
            <MudButton OnClick="Cancel">@Loc["Cancel"]</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">@(_isEdit ? Loc["Update"] : Loc["Create"])</MudButton>
        </MudStack>
    </MudPaper>
</MudOverlay>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    [Parameter] public int? AssetId { get; set; }
    [Parameter] public int? PreselectedEmployeeId { get; set; }

    private Asset _asset = new Asset();
    private List<AssetType> _assetTypes = new();
    private List<AssetStatus> _assetStatuses = new();
    private List<EmployeeInfo> _employees = new();
    
    private DateTime? _receiveDate;
    private DateTime? _returnDate;

    private MudForm _form;
    private bool _success;
    private bool _isEdit => AssetId.HasValue;

    protected override async Task OnParametersSetAsync()
    {
        if (Visible)
        {
            if (!_assetTypes.Any() || !_assetStatuses.Any() || !_employees.Any())
            {
               await LoadLookups();
            }

            if (AssetId.HasValue)
            {
                var asset = await AssetsService.GetAssetByIdAsync(AssetId.Value);
                if (asset != null)
                {
                    _asset = asset;
                    _receiveDate = _asset.ReceiveDate;
                    _returnDate = _asset.ReturnDate;
                }
            }
            else
            {
                _asset = new Asset();
                _receiveDate = DateTime.Today;
                _returnDate = null;
                
                if (PreselectedEmployeeId.HasValue)
                {
                    _asset.EmployeeId = PreselectedEmployeeId.Value;
                }
            }
        }
    }

    private async Task LoadLookups()
    {
        var typesTask = LookupsService.GetAssetTypesAsync();
        var statusesTask = LookupsService.GetAssetStatusesAsync();
        var employeesTask = EmployeesService.GetAllEmployeesAsync();

        await Task.WhenAll(typesTask, statusesTask, employeesTask);

        _assetTypes = await typesTask;
        _assetStatuses = await statusesTask;
        _employees = await employeesTask;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadLookups();
    }

    private async Task Submit()
    {
        await _form.Validate();

        if (_success)
        {
            if (_receiveDate.HasValue) _asset.ReceiveDate = _receiveDate.Value;
            if (_returnDate.HasValue) _asset.ReturnDate = _returnDate;
            else _asset.ReturnDate = null;

            if (_isEdit)
            {
                var result = await AssetsService.UpdateAssetAsync(_asset.Id, _asset);
                if (result != null)
                {
                    Snackbar.Add(Loc["AssetUpdated"], Severity.Success);
                    await Close(true);
                }
                else
                {
                    Snackbar.Add(Loc["Error"], Severity.Error);
                }
            }
            else
            {
                try
                {
                    _asset.Id = 0;
                    await AssetsService.CreateAssetAsync(_asset);
                    Snackbar.Add(Loc["AssetCreated"], Severity.Success);
                    await Close(true);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"{Loc["Error"]}: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task Close(bool success = false)
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        await OnClose.InvokeAsync(success);
    }
    
    private async Task Cancel() => await Close(false);
}
