@using Platform.Data.DTOs
@using Platform.Blazor.Services.Employees
@using Platform.Blazor.Services.Hierarchies
@using Platform.Blazor.Services.Auth
@using MudBlazor
@inject IEmployeesService EmployeesService
@inject IHierarchiesService HierarchiesService
@inject IApplicationUsersService UsersService
@inject ISnackbar Snackbar
@inject Platform.Blazor.Services.Leaves.LeaveService LeaveService

<MudOverlay @bind-Visible="Visible" DarkBackground="true" AutoClose="false" ZIndex="9999">
    <MudPaper Class="pa-4" Style="width: 400px; max-width: 90vw;">
        <MudText Typo="Typo.h6" Class="mb-4">@(_isEdit ? "Edit Employee" : "Add Employee")</MudText>
        <MudForm @ref="_form" @bind-IsValid="_success">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_employee.FullName" Label="Full Name" Required="true" RequiredError="Full Name is required!" />
                <MudTextField @bind-Value="_employee.CivilId" Label="Civil ID" Required="true" RequiredError="Civil ID is required!" />
                <MudTextField @bind-Value="_employee.EmployeeId" Label="Employee ID" Required="true" RequiredError="Employee ID is required!" />
                
                <MudSelect T="int" @bind-Value="_employee.HierarchyId" Label="Hierarchy" Required="true" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var hierarchy in _hierarchies)
                    {
                        <MudSelectItem Value="@hierarchy.Id">@hierarchy.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="string" @bind-Value="_employee.AspnetusersId" Label="User Account" HelperText="Optional: Assign a login account" AnchorOrigin="Origin.BottomCenter" Clearable="true">
                        @foreach (var user in _users)
                    {
                        <MudSelectItem Value="@user.Id">@user.UserName (@user.Email)</MudSelectItem>
                    }
                </MudSelect>


                @if (!_isEdit)
                {
                    <MudText Typo="Typo.subtitle1" Class="mt-4">Initial Leave Balances</MudText>
                    <MudDivider />
                    <MudStack Spacing="2" Class="mt-2">
                        @foreach (var item in _leaveBalanceModels)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudCheckBox @bind-Value="item.IsSelected" Label="@item.Type.Name" Dense="true" Color="Color.Primary" />
                                <MudNumericField @bind-Value="item.Balance" Label="Balance" Disabled="@(!item.IsSelected)" Variant="Variant.Outlined" Margin="Margin.Dense" Class="ml-4" Style="width: 100px;" />
                            </MudStack>
                        }
                    </MudStack>
                }
            </MudStack>
        </MudForm>
        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
            <MudButton OnClick="Cancel">Cancel</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">@(_isEdit ? "Update" : "Create")</MudButton>
        </MudStack>
    </MudPaper>
</MudOverlay>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    [Parameter] public int? EmployeeId { get; set; }

    private EmployeeInfo _employee = new EmployeeInfo();
    private List<Hierarchy> _hierarchies = new();

    private List<ApplicationUser> _users = new();
    private List<LeaveBalanceModel> _leaveBalanceModels = new();
    
    private MudForm _form;
    private bool _success;
    private bool _isEdit => EmployeeId.HasValue;

    protected override async Task OnParametersSetAsync()
    {
        if (Visible)
        {
             // Reset or load data when dialog becomes visible
             // However, OnInitializedAsync runs only once.
             // We should check if we need to reload.
             // For simplicity, we can load looks ups in OnInitialized, but Employee data in OnParametersSet if ID changed.
             // Better: Move Load Data to a separate method and call it when Visible becomes true?
             // Or simplier: The parent sets EmployeeId, then sets Visible=true.
             // We can detect change in Visible or EmployeeId.
             
             if (EmployeeId.HasValue)
             {
                 var info = await EmployeesService.GetEmployeeInfoByIdAsync(EmployeeId.Value);
                 if (info != null)
                 {
                     _employee = info;
                 }
             }
             else
             {
                 _employee = new EmployeeInfo();
             }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var hierarchyTask = HierarchiesService.GetHierarchiesAsync();
        var usersTask = UsersService.GetAllUsersAsync();
        
        await Task.WhenAll(hierarchyTask, usersTask);
        
        _hierarchies = await hierarchyTask;

        _users = await usersTask;

        // Load Leave Types for new employee
        if (!_isEdit)
        {
            var leaveTypes = await LeaveService.GetLeaveTypes();
            _leaveBalanceModels = leaveTypes.Select(lt => new LeaveBalanceModel
            {
                Type = lt,
                IsSelected = true,
                Balance = lt.TypeBalance
            }).ToList();
        }
    }

    private async Task Submit()
    {
        await _form.Validate();

        if (_success)
        {
            if (_isEdit)
            {
                var employeeToUpdate = new Employee
                {
                    Id = _employee.Id,
                    CivilId = _employee.CivilId,
                    EmployeeId = _employee.EmployeeId,
                    HierarchyId = _employee.HierarchyId,
                    AspnetusersId = _employee.AspnetusersId,
                    FullName = _employee.FullName
                };

                var result = await EmployeesService.UpdateEmployeeAsync(_employee.Id, employeeToUpdate);
                if (result != null)
                {
                    Snackbar.Add("Employee updated successfully", Severity.Success);
                    await Close(true);
                }
                else
                {
                    Snackbar.Add("Failed to update employee", Severity.Error);
                }
            }
            else
            {
                try
                {
                    // Ensure ID is 0
                    var employeeToCreate = new Employee
                    {
                        Id = 0,
                        CivilId = _employee.CivilId,
                        EmployeeId = _employee.EmployeeId,
                        HierarchyId = _employee.HierarchyId,
                        AspnetusersId = _employee.AspnetusersId,
                        FullName = _employee.FullName
                    };
                    await EmployeesService.CreateEmployeeAsync(employeeToCreate);
                    Snackbar.Add("Employee created successfully", Severity.Success);
                    await Close(true);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to create employee: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private async Task Close(bool success = false)
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        await OnClose.InvokeAsync(success);
    }
    
    private async Task Cancel() => await Close(false);

    public class LeaveBalanceModel
    {
        public LeaveType Type { get; set; }
        public bool IsSelected { get; set; }
        public int? Balance { get; set; }
    }
}
