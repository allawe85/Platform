@using Platform.Data.DTOs
@using Platform.Blazor.Services.Employees
@using Platform.Blazor.Services.Hierarchies
@using Platform.Blazor.Services.Auth
@using Platform.Blazor.Services.Roles
@using MudBlazor
@inject IEmployeesService EmployeesService
@inject IHierarchiesService HierarchiesService
@inject IApplicationUsersService UsersService
@inject IRolesService RolesService
@inject ISnackbar Snackbar
@inject Platform.Blazor.Services.Leaves.LeaveService LeaveService

<MudDialog>
    <DialogContent>
        <MudPaper Elevation="0" Style="max-height:70vh; overflow-y:auto;" Class="pa-2">
            <MudForm @ref="_form" @bind-IsValid="_success">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">@Loc["EmployeeDetails"]</MudText>
                    <MudTextField @bind-Value="_employee.FullName" Label="@Loc["FullName"]" Required="true" RequiredError="@Loc["FullNameRequired"]" />
                    <MudTextField @bind-Value="_employee.CivilId" Label="@Loc["CivilId"]" Required="true" RequiredError="@Loc["CivilIdRequired"]" />
                    <MudTextField @bind-Value="_employee.EmployeeId" Label="@Loc["EmployeeId"]" Required="true" RequiredError="@Loc["EmployeeIdRequired"]" />
                    
                    <MudSelect T="int?" Value="@(_employee.HierarchyId == 0 ? (int?)null : _employee.HierarchyId)" ValueChanged="@(val => _employee.HierarchyId = val ?? 0)" Label="@Loc["Hierarchy"]" Required="true" AnchorOrigin="Origin.BottomCenter" Placeholder="@Loc["PleaseSelect"]">
                        @foreach (var hierarchy in _hierarchies)
                        {
                            <MudSelectItem T="int?" Value="@((int?)hierarchy.Id)">@hierarchy.Name</MudSelectItem>
                        }
                    </MudSelect>

                    <MudDivider Class="my-2"/>
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">@Loc["UserAccount"]</MudText>
                    
                    @if (!_isEdit)
                    {
                        <MudCheckBox @bind-Value="_createUserAccount" Label="@Loc["CreateUserAccount"]" Color="Color.Primary" Dense="true"/>
                    }
                    
                    @if (_createUserAccount || (_isEdit && _hasUserAccount))
                    {
                        <MudTextField @bind-Value="_userName" Label="@Loc["Username"]" Required="@(_createUserAccount)" Disabled="@_isEdit" />
                        <MudTextField @bind-Value="_email" Label="@Loc["Email"]" Required="@(_createUserAccount)" InputType="InputType.Email" />
                        <MudTextField @bind-Value="_phoneNumber" Label="@Loc["Phone"]" InputType="InputType.Telephone" />
                        
                        @if (!_isEdit)
                        {
                            <MudTextField @bind-Value="_password" Label="@Loc["Password"]" InputType="InputType.Password" Required="@(_createUserAccount)" />
                        }

                         <MudSelect T="string" @bind-Value="_role" Label="@Loc["Role"]" Required="@(_createUserAccount)" AnchorOrigin="Origin.BottomCenter" Placeholder="@Loc["PleaseSelect"]">
                            @foreach (var r in _roles)
                            {
                                <MudSelectItem Value="@r">@r</MudSelectItem>
                            }
                        </MudSelect>
                        
                         @if (_isEdit)
                         {
                             <MudDivider Class="my-2"/>
                             <MudCheckBox @bind-Value="_linkExistingAccount" Label="@Loc["ChangeLinkedUser"]" Color="Color.Secondary" Dense="true" />
                         }
                    }
                    
                    @if (_isEdit && (!_hasUserAccount || _linkExistingAccount))
                    {
                         @if (!_hasUserAccount && !_linkExistingAccount)
                         {
                              <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">@Loc["NoUserAccountLinked"]</MudAlert>
                              <MudCheckBox @bind-Value="_linkExistingAccount" Label="@Loc["LinkExistingAccount"]" Color="Color.Primary" Dense="true" />
                         }
                         
                         @if (_linkExistingAccount)
                         {
                             <MudAutocomplete T="ApplicationUser" Label="@Loc["SelectUser"]" @bind-Value="_selectedUser"
                                              SearchFunc="@SearchUsers" ToStringFunc="@(u => u==null ? null : $"{u.Email} ({u.UserName})")"
                                              ResetValueOnEmptyText="true"
                                              CoerceText="true" CoerceValue="true"
                                              Required="true" RequiredError="@Loc["UserRequired"]"
                                              AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary" />
                         }
                    }


                    @if (!_isEdit)
                    {
                        <MudDivider Class="my-2"/>
                        <MudText Typo="Typo.subtitle1">@Loc["InitialLeaveBalances"]</MudText>
                        <MudStack Spacing="2" Class="mt-2">
                            @foreach (var item in _leaveBalanceModels)
                            {
                                var name = System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("ar") ? item.Type.NameAr : item.Type.Name;
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudCheckBox @bind-Value="item.IsSelected" Label="@name" Dense="true" Color="Color.Primary" />
                                    <MudNumericField @bind-Value="item.Balance" Label="@Loc["Balance"]" Disabled="@(!item.IsSelected)" Variant="Variant.Outlined" Margin="Margin.Dense" Class="ml-4" Style="width: 100px;" HideSpinButtons="true" />
                                </MudStack>
                            }
                        </MudStack>
                    }
                </MudStack>
            </MudForm>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@Loc["Cancel"]</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">@(_isEdit ? Loc["Update"] : Loc["Create"])</MudButton>
    </DialogActions>
</MudDialog>



@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    [Parameter] public int? EmployeeId { get; set; }

    private EmployeeInfo _employee = new EmployeeInfo();
    private List<Hierarchy> _hierarchies = new();
    private List<string> _roles = new();

    private List<LeaveBalanceModel> _leaveBalanceModels = new();
    
    // User fields
    private bool _createUserAccount;
    private bool _linkExistingAccount;
    private List<ApplicationUser> _allUsers = new();
    private bool _hasUserAccount;
    private string _userName;
    private string _email;
    private string _phoneNumber;
    private string _password; // Only for create
    private string _role;

    private MudForm _form;
    private bool _success;
    private bool _isEdit => EmployeeId.HasValue;

    protected override async Task OnInitializedAsync()
    {
        // Load Hierarchies
        _hierarchies = await HierarchiesService.GetHierarchiesAsync();
        
        if (EmployeeId.HasValue)
        {
            var info = await EmployeesService.GetEmployeeInfoByIdAsync(EmployeeId.Value);
            if (info != null)
            {
                _employee = info;
                
                // Populate user fields
                _hasUserAccount = !string.IsNullOrEmpty(info.AspnetusersId);
                if (_hasUserAccount)
                {
                    _userName = info.UserName;
                    _email = info.Email;
                    _phoneNumber = info.PhoneNumber;
                    _role = info.Role; 
                }
            }
        }
        else
        {
            _employee = new EmployeeInfo();
            _createUserAccount = false;
            _hasUserAccount = false;
            _userName = "";
            _email = "";
            _phoneNumber = "";
            _password = "";
            _role = "User"; // Default
            
            var leaveTypes = await LeaveService.GetLeaveTypes();
            _leaveBalanceModels = leaveTypes.Select(lt => new LeaveBalanceModel
            {
                Type = lt,
                IsSelected = true,
                Balance = lt.TypeBalance
            }).ToList();
        }

        // Load and Filter Roles (frontend safety filter)
        var rawRoles = await RolesService.GetRolesAsync();
        _roles = rawRoles
            .Where(r => !string.Equals(r, "Admin", StringComparison.OrdinalIgnoreCase) || string.Equals(_role, "Admin", StringComparison.OrdinalIgnoreCase))
            .ToList();
            
        // Load all users for linking consideration
        if (_isEdit)
        {
            _allUsers = await UsersService.GetAllUsersAsync();
        }

        StateHasChanged();
    }

    private async Task<IEnumerable<ApplicationUser>> SearchUsers(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return _allUsers;
        return _allUsers.Where(x => x.Email.Contains(value, StringComparison.InvariantCultureIgnoreCase) || x.UserName.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }
    
    private ApplicationUser _selectedUser
    {
        get => __selectedUser;
        set
        {
            __selectedUser = value;
            if (value != null)
            {
                _employee.AspnetusersId = value.Id;
                _userName = value.UserName;
                _email = value.Email;
                _phoneNumber = value.PhoneNumber;
            }
        }
    }
    private ApplicationUser __selectedUser;

    private async Task Submit()
    {
        await _form.Validate();

        if (_success)
        {
            if (_isEdit)
            {
                var employeeToUpdate = new Employee
                {
                    Id = _employee.Id,
                    CivilId = _employee.CivilId,
                    EmployeeId = _employee.EmployeeId,
                    HierarchyId = _employee.HierarchyId,
                    AspnetusersId = _employee.AspnetusersId,
                    FullName = _employee.FullName
                };

                var updateRequest = new UpdateEmployeeRequest 
                {
                    Employee = employeeToUpdate,
                    Email = _email,
                    PhoneNumber = _phoneNumber,
                    Role = _role
                };

                var result = await EmployeesService.UpdateEmployeeAsync(_employee.Id, updateRequest);
                if (result != null)
                {
                    Snackbar.Add("Employee updated successfully", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to update employee", Severity.Error);
                }
            }
            else
            {
                try
                {
                    var employeeToCreate = new Employee
                    {
                        Id = 0,
                        CivilId = _employee.CivilId,
                        EmployeeId = _employee.EmployeeId,
                        HierarchyId = _employee.HierarchyId,
                        AspnetusersId = null, // Will be set by server if user created
                        FullName = _employee.FullName
                    };

                    RegisterRequest userRequest = null;
                    if (_createUserAccount)
                    {
                        userRequest = new RegisterRequest
                        {
                            UserName = _userName,
                            Email = _email,
                            Password = _password
                        };
                    }

                    var request = new CreateEmployeeRequest
                    {
                        Employee = employeeToCreate,
                        UserAccount = userRequest,
                        Role = _role,
                        LeaveBalances = _leaveBalanceModels
                            .Where(x => x.IsSelected)
                            .Select(x => new LeaveBalance
                            {
                                LeaveTypeId = x.Type.Id,
                                Balance = x.Balance,
                                EmployeeId = 0 
                            }).ToList()
                    };

                    await EmployeesService.CreateEmployeeAsync(request);
                    Snackbar.Add("Employee created successfully", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Failed to create employee: {ex.Message}", Severity.Error);
                }
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();

    public class LeaveBalanceModel
    {
        public LeaveType Type { get; set; }
        public bool IsSelected { get; set; }
        public int? Balance { get; set; }
    }
}
