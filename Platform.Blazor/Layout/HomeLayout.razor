@inherits LayoutComponentBase
@inject IAuthService Auth
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@using System.Security.Claims
@using Platform.Blazor.Services.Auth
@using System.Globalization
@using Microsoft.Extensions.Localization
@using Platform.Blazor.Resources
@inject LayoutService LayoutService
@implements IDisposable
@inject IStringLocalizer<AppStrings> Loc

<MudLayout>
    <MudAppBar Elevation="1" Style="height: 80px; background-color: #007FFF;">
        <MudText Typo="Typo.h5" Class="ml-3" Style="font-weight: 700;">Platform</MudText>
        <MudSpacer />
        @if (!string.IsNullOrEmpty(_username))
        {
            <MudText Class="mr-4" Style="font-weight: 700;">@Loc["Welcome"], @_username</MudText>
            <MudIconButton Icon="@(LayoutService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" Color="Color.Inherit" OnClick="ToggleDarkMode" />
            <MudIconButton Icon="@Icons.Material.Filled.Language" Color="Color.Inherit" OnClick="ToggleLanguage" />
        }
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End">
            <MudMenuItem OnClick="Logout">@Loc["Logout"]</MudMenuItem>
        </MudMenu>
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
            @Body
        </MudContainer>
    </MudMainContent>
    
    <MudThemeProvider @ref="@_mudThemeProvider" Theme="@LayoutService.CurrentTheme" IsDarkMode="@LayoutService.IsDarkMode" />
    <MudDialogProvider />
    <MudSnackbarProvider />
    <MudPopoverProvider />
</MudLayout>

@code {
    string? _username;
    MudThemeProvider _mudThemeProvider;

    protected override async Task OnInitializedAsync()
    {
        LayoutService.OnMajorUpdate += StateHasChanged;
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        _username = state.User.Identity?.Name;
    }

    async Task Logout()
    {
        await Auth.LogoutAsync();
        Nav.NavigateTo("/login");
    }

    async Task ToggleLanguage()
    {
        var currentCulture = CultureInfo.CurrentCulture;
        var newCultureName = currentCulture.Name == "en-US" ? "ar-EG" : "en-US";
        
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "culture", newCultureName);

        Nav.NavigateTo(Nav.Uri, forceLoad: true);
    }

    async Task ToggleDarkMode()
    {
        LayoutService.ToggleDarkMode();
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "darkMode", LayoutService.IsDarkMode.ToString());
    }

    public void Dispose()
    {
        LayoutService.OnMajorUpdate -= StateHasChanged;
    }
}
